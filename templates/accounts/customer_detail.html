{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>{{ customer.name }} - Account</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'accounts/js/chart.js' %}"></script>

<style>
body{background:#f4f6f9}
.fade-card{animation:fadeUp .3s ease-out both}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
.action-btn{padding:2px 6px}
</style>
</head>

<body>
<div class="container mt-4">

<!-- HEADER -->
<div class="card fade-card p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h4 class="mb-1">{{ customer.name }}</h4>
      <small>
        Balance: â‚¹ <span id="balanceAmount">{{ customer.balance_amount|floatformat:2 }}</span>
      </small>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'accounts:add_entry' %}" class="btn btn-primary btn-sm">â• Add</a>
      <a href="{% url 'accounts:bill_pdf' customer.id %}" class="btn btn-danger btn-sm">ğŸ“„ Full Bill</a>
    </div>
  </div>
</div>

<!-- MONTHLY ENTRIES -->
{% for month in months_data %}
<div class="card fade-card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>{{ month.month_name }}</strong>

    <div class="d-flex gap-2">
      <a href="{% url 'accounts:bill_pdf_month' customer.id month.year month.month %}"
         class="btn btn-outline-danger btn-sm">ğŸ“¥ PDF</a>

      <form method="post"
        {% csrf_token %}
        <button type="submit" href="https://web.whatsapp.com/" class="btn btn-success btn-sm">
          ğŸ’¬ WhatsApp
        </button>
      </form>
    </div>
  </div>

  <table class="table table-sm mb-0">
    <thead>
      <tr>
        <th>Date</th>
        <th class="text-end">ML</th>
        <th class="text-end">Litres</th>
        <th class="text-end">Amount</th>
        <th class="text-end">Action</th>
      </tr>
    </thead>
    <tbody>
    {% for entry in month.entries %}
      <tr data-entry-id="{{ entry.id }}">
        <td>{{ entry.date|date:"d-m-Y" }}</td>
        <td class="text-end">{{ entry.quantity_ml }}</td>
        <td class="text-end">{{ entry.litres|floatformat:2 }}</td>
        <td class="text-end amount">â‚¹ {{ entry.amount|floatformat:2 }}</td>
        <td class="text-end">
          <a href="{% url 'accounts:edit_entry' entry.id %}"
             class="btn btn-sm btn-outline-warning action-btn">âœï¸</a>

          <button
            type="button"
            class="btn btn-sm btn-outline-danger action-btn"
            onclick="deleteEntry(
              '{% url 'accounts:delete_entry' entry.id %}',
              '{% url 'accounts:restore_entry' entry.id %}',
              this
            )">ğŸ—‘ï¸</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% empty %}
<div class="text-center text-muted">No entries found.</div>
{% endfor %}

<!-- CHART -->
<div class="card fade-card p-3">
  <h6>ğŸ“Š Consumption Trend</h6>
  <canvas id="milkChart"></canvas>
</div>

</div>

<!-- UNDO TOAST -->
<div id="undoToast"
     style="display:none;position:fixed;bottom:20px;right:20px;
            background:#111;color:#fff;padding:10px 14px;border-radius:6px;">
  Entry deleted
  <button type="button" onclick="undoDelete()" class="btn btn-sm btn-light ms-2">Undo</button>
</div>

<script>
let lastDeleted = null;
let lastRestoreUrl = null;

function getCSRFToken(){
  return document.cookie.split(';')
    .find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
}

function deleteEntry(deleteUrl, restoreUrl, btn){
  if(!confirm("Delete this entry?")) return;

  fetch(deleteUrl,{
    method:"POST",
    headers:{
      "X-CSRFToken": getCSRFToken(),
      "X-Requested-With":"XMLHttpRequest"
    }
  })
  .then(res => {
    if(!res.ok) throw new Error("Delete failed");
    return res.json();
  })
  .then(() => {
    const row = btn.closest("tr");
    lastDeleted = row;
    lastRestoreUrl = restoreUrl;

    const amt = parseFloat(row.querySelector(".amount").innerText.replace("â‚¹",""));
    const bal = document.getElementById("balanceAmount");
    bal.innerText = (parseFloat(bal.innerText) - amt).toFixed(2);

    row.style.display="none";
    document.getElementById("undoToast").style.display="block";
    setTimeout(() => {
      document.getElementById("undoToast").style.display="none";
    }, 6000);
  })
  .catch(() => alert("Delete failed. Please refresh."));
}

function undoDelete(){
  if(!lastDeleted) return;

  fetch(lastRestoreUrl,{
    method:"POST",
    headers:{
      "X-CSRFToken": getCSRFToken(),
      "X-Requested-With":"XMLHttpRequest"
    }
  })
  .then(res => {
    if(!res.ok) throw new Error();
    const amt = parseFloat(lastDeleted.querySelector(".amount").innerText.replace("â‚¹",""));
    const bal = document.getElementById("balanceAmount");
    bal.innerText = (parseFloat(bal.innerText) + amt).toFixed(2);

    lastDeleted.style.display="";
    lastDeleted = null;
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  loadMilkChart("{% url 'accounts:chart_data' customer.id %}", "milkChart");
});
</script>

</body>
</html>
