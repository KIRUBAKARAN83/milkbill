{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>{{ customer.name }} - Account</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'accounts/js/chart.js' %}"></script>

<style>
body{background:#f4f6f9}
.fade-card{animation:fadeUp .35s ease-out both}
@keyframes fadeUp{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1}
}
.month-card{
    border-left:4px solid #0d6efd;
    transition:transform .2s, box-shadow .2s;
}
.month-card:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(0,0,0,.08);
}
.table tbody tr{
    transition:background .15s;
}
.table tbody tr:hover{
    background:#f1f5f9;
}
.action-col{
    width:120px;
    white-space:nowrap;
}
.action-btn{
    padding:2px 6px;
}
</style>
</head>

<body>
<div class="container mt-4">
    

<!-- Customer header -->
<div class="card fade-card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-1">{{ customer.name }}</h4>
            <small class="text-muted">
                Balance: â‚¹ {{ customer.balance_amount|floatformat:2 }}
            </small>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'accounts:add_entry' %}" class="btn btn-primary btn-sm">â• Add</a>
            <a href="{% url 'accounts:bill_pdf' customer.id %}" class="btn btn-danger btn-sm">ğŸ“„ Bill</a>
            <a href="{% url 'accounts:customer_list' %}" class="btn btn-secondary">â† Back to Customers</a>
        </div>
    </div>
</div>

<!-- Monthly entries -->
{% for month in months_data %}
<div class="card month-card mb-3 fade-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>{{ month.month_name }}</strong>
        <a href="{% url 'accounts:bill_pdf_month' customer.id month.year month.month %}"
           class="btn btn-outline-danger btn-sm">ğŸ“¥ PDF</a>
    </div>

    <table class="table table-sm mb-0">
        <thead class="table-light">
            <tr>
                <th>Date</th>
                <th class="text-end">ML</th>
                <th class="text-end">Litres</th>
                <th class="text-end">Amount</th>
                <th class="text-end action-col">Action</th>
            </tr>
        </thead>
        <tbody>
        {% for entry in month.entries %}
        <tr>
            <td>{{ entry.date|date:"d-m-Y" }}</td>
            <td class="text-end">{{ entry.quantity_ml }}</td>
            <td class="text-end">{{ entry.litres|floatformat:2 }}</td>
            <td class="text-end">â‚¹ {{ entry.amount|floatformat:2 }}</td>

            <!-- ACTIONS -->
            <td class="text-end action-col">
                <a href="{% url 'accounts:edit_entry' entry.id %}"
                   class="btn btn-sm btn-outline-warning action-btn"
                   title="Edit entry">
                    âœï¸
                </a>

                <form method="post"
                      action="{% url 'accounts:delete_entry' entry.id %}"
                      class="d-inline"
                      onsubmit="return confirm('Delete entry on {{ entry.date|date:\"d-m-Y\" }}?');">
                    {% csrf_token %}
                    <button type="submit"
                            class="btn btn-sm btn-outline-danger action-btn"
                            title="Delete entry">
                        ğŸ—‘ï¸
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endfor %}

<!-- Chart -->
<div class="card fade-card p-3">
    <h6 class="mb-2">ğŸ“Š Consumption Trend</h6>
    <canvas id="milkChart" height="280"></canvas>
</div>

</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
    loadMilkChart("{% url 'accounts:chart_data' customer.id %}", 'milkChart');
});
</script>
    <script>
function getCSRFToken() {
    let cookieValue = null;
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith('csrftoken=')) {
            cookieValue = cookie.substring('csrftoken='.length);
            break;
        }
    }
    return cookieValue;
}

function deleteEntry(entryId, btn) {
    if (!confirm("Delete this entry?")) return;

    fetch(`/entry/${entryId}/delete/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
        },
    })
    .then(response => {
        if (!response.ok) {
            alert("Delete failed. Try again.");
            return;
        }

        // Smooth fade-out animation
        const row = btn.closest("tr");
        row.style.transition = "opacity 0.25s ease";
        row.style.opacity = "0";

        setTimeout(() => {
            row.remove();
        }, 250);
    })
    .catch(() => {
        alert("Network error. Try again.");
    });
}
</script>

</body>
</html>
